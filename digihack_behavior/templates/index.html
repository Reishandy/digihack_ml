<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YOLO One-Shot Realtime</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div class="container">
      <h1>YOLO One-Shot Realtime Predict</h1>

      <div class="video-wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none"></canvas>
      </div>

      <div class="controls">
        <button id="start-camera">Start Camera</button>
        <button id="predict-once" disabled>Predict Once</button>
        <p id="status"></p>
      </div>

      <div id="result">
        <h3>Result</h3>
        <img id="result-img" src="" alt="Hasil prediksi" style="display:none; max-width:100%"/>
      </div>
    </div>

    <script>
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const startBtn = document.getElementById('start-camera');
      const predictBtn = document.getElementById('predict-once');
      const status = document.getElementById('status');
      const resultImg = document.getElementById('result-img');

      let stream = null;

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          video.srcObject = stream;
          predictBtn.disabled = false;
          status.innerText = 'Kamera aktif, siap memprediksi.';
        } catch (err) {
          status.innerText = 'Gagal akses kamera: ' + err.message;
        }
      }

      function stopCamera() {
        if (stream) {
          const tracks = stream.getTracks();
          tracks.forEach(track => track.stop());
          stream = null;
        }
        video.srcObject = null;
        predictBtn.disabled = true;
        startBtn.disabled = false;
      }

      startBtn.addEventListener('click', () => {
        startBtn.disabled = true;
        startCamera();
      });

      predictBtn.addEventListener('click', async () => {
        if (!stream) return;

        predictBtn.disabled = true;
        status.innerText = 'Processing...';

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataUrl = canvas.toDataURL('image/png');

        try {
          const resp = await fetch('/predict_frame', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: dataUrl })
          });
          if (!resp.ok) throw new Error('Server error');

          const j = await resp.json();
          if (j.result_url) {
            resultImg.src = j.result_url + '?t=' + Date.now();
            resultImg.style.display = 'block';
            status.innerText = 'Prediksi selesai. Kamera dimatikan.';
          } else {
            status.innerText = 'Tidak ada hasil.';
          }
        } catch (err) {
          status.innerText = 'Error: ' + err.message;
        } finally {
          stopCamera();
        }
      });
    </script>
  </body>
</html>